# 索引的声明和使用

## 1. 分类

### 1.1 逻辑功能

**普通索引**

- 不加任何限制条件，只是为了提高查询效率
- 可以创建在<font color=orange>任何数据类型上</font>，其值是否唯一和非空，要由字段本身的完整性约束条件决定
- 建立索引后，可以通过索引进行查询

**唯一索引**

- 使用<font color=orange>UNIQUE</font>设置字段，就会自动添加唯一索引
- 该索引的值必须是唯一的，但允许有空值
- 一个表中<font color=orange>可以有多个</font>

**主键索引**

- 一种<font color=orange>特殊的唯一性索引</font>，在唯一索引的基础上增加了不为空的约束：NOT NULL + UNIQUE
- 一个表中只能包含一个主键索引：主键索引决定了数据的存储方式

**全文索引**

- 是目前<font color=orange>搜索引擎</font>使用的一种技术，利用<font color=orange>分词技术</font>等多种算法智能分析
- 一般是用Elastic Search来替代

### 1.2 物理实现方式

- 聚簇索引
- 非聚簇索引

### 1.3 作用字段个数

- 单列索引
- 联合索引：作用在多个字段上

## 2. 创建索引

### 2.1 创建表时创建

- <font color=orange> INDEX | KEY </font>： 同义词
- <font color=orange>index_name</font>： 索引名称，可选参数。默认是col_name为索引名
- <font color=orange>col_name</font>：需要创建索引的字段列
- <font color=orange>length</font>：可选参数，表示索引的长度，只有字符串类型的字段才能指定索引长度
- <font color=orange>ASC | DESC</font>：指定生序或者降序的索引值存储

```SQL
CREATE TABLE table_name [col_name data_type]
[UNIQUE | FULLTEXT] [INDEX | KEY] [index_name] (col_name[length])
[ASC | DESC]
```

```sql
CREATE TABLE book1
(
    id      INT,
    name    VARCHAR(100),
    comment VARCHAR(100),
    price   INT,
    # 普通索引
    INDEX name_index (name),
    # 唯一索引
    UNIQUE INDEX comment_index (comment),
    # 主键索引：名字就是PRIMARY，自定义名字不会起作用
    PRIMARY KEY (id),
    # 联合索引: 也可以为unique, 最左前缀原则
    INDEX mul_name_comment_price_index (name, comment, price)
);

# 查看索引
SHOW INDEX FROM book1;
```

### 2.2 现有表上创建

```SQL
# 普通索引
ALTER TABLE book2
    ADD INDEX name_index (name);
# 唯一索引
ALTER TABLE book2
    ADD UNIQUE INDEX comment_index (comment);
# 主键索引
ALTER TABLE book2
    ADD PRIMARY KEY (id);
# 联合索引
ALTER TABLE book2
    ADD INDEX mul_name_comment_price_index (name, comment, price);
```

```SQL
# 普通索引
CREATE INDEX name_index ON book3 (name);
# 唯一索引
CREATE UNIQUE INDEX comment_index ON book3 (comment);
# 联合索引
CREATE INDEX mul_name_comment_price_index ON book3 (name, comment, price);
# 主键索引: 不能通过这种方式
```

### 2.3 删除索引

- 删除索引时，是根据名字来匹配的，所以不需要指定索引类型，除了主键索引

```sql
# 普通索引
ALTER TABLE book2
    DROP INDEX name_index;
# 唯一索引： 不是drop unique index
ALTER TABLE book2
    DROP INDEX comment_index;
# 主键索引
ALTER TABLE book2
    DROP PRIMARY KEY;
# 联合索引
ALTER TABLE book2
    DROP INDEX mul_name_comment_price_index;
```

```sql
# 普通索引
DROP INDEX name_index ON book3;
# 唯一索引
DROP INDEX comment_index ON book3;
# 联合索引
DROP INDEX mul_name_comment_price_index ON book3;
```

```sql
# 删除某个字段时候，假如该字段有索引，对应索引也会删除
# 删除某个字段的时候，假如该字段具有联合索引，联合索引的该字段也会更新删除
ALTER TABLE book2 DROP COLUMN name;
```

## 3. MySQL8.0新特性

### 3.1 降序索引

- <font color=orange>MySQL8.0之前，索引都是升序，使用时进行反向扫描，大大降低数据库的效率(单链表逆向遍历)</font>
- 某些操作，需要对多个列进行排序，且顺序要求不一致，使用降序索 引就会避免数据库使用额外的文件排序操作，提高性能

```sql
CREATE TABLE book4
(
    id      INT,
    name    VARCHAR(100),
    comment VARCHAR(100),
    price   INT,
    INDEX name_comment_index (name ASC, comment DESC)
);
```

### 3.2 隐藏索引

```bash
# 引入场景：打算删除一个索引，看一下删除后会不会对系统有影响

# 5.7及之前
- 先显示删除索引
- 删除后发现系统错误，只能显示的再去创建删除的索引
- 如果表中数据量很大，这种操作就会消耗系统过多的资源，操作成本比较高

# 8.0-隐藏索引： 软删除
- 将待删除的索引设置为隐藏索引，查询优化器就不再使用这个索引(即使使用force index,优化器也不会使用该索引)
- 确认变为隐藏索引后，系统不受任何影响，就可以彻底删除该索引
```

- 主键不能设置为隐藏索引。当表中没有显示主键时，表中第一个唯一非空索引会成为隐式主键，也不能设置为隐藏索引
- <font color=orange>索引被隐藏时，对应的B+树仍然和正常索引一样，随着写操作进行实时更新</font>，索引如果需要被长期隐藏，那么建议将其删除，因为索引的存在会影响写性能

```sql
# 创建表时
CREATE TABLE book5
(
    id      INT,
    name    VARCHAR(100),
    comment VARCHAR(100),
    price   INT,
    INDEX name_index (name) INVISIBLE
);

# 创建表后
ALTER TABLE book5
    ADD index comment_index (comment) INVISIBLE;

CREATE INDEX price_index ON book5 (price) INVISIBLE;

# 修改索引可见性
ALTER TABLE book5
    ALTER INDEX comment_index INVISIBLE;
```

## 4. 适合加索引

### 4.1 字段数值有唯一性

- 某个字段是唯一的：创建<font color=orange>唯一索引，或者主键索引</font>
- 业务上具有唯一特性的字段：<font color=orange>即使是组合字段，也必须建成唯一聚簇索引</font>(阿里规范)
- 唯一索引影响了insert速度，但损耗可以忽略，但提高查找速度很明显(查找B+树，找到一条记录后，就不再查找其余的页了)

### 4.2 频繁作为WHERE查询条件的字段

- 创建普通索引就可以大幅度提升数据查询的效率(根据B+树的搜索，可能搜索到多个数据页，但是不用扫全部页)

### 4.3 经常GROUP BY和ORDER BY的列

- 索引就是让数据按照某种顺序进行存储和检索
- 创建单列索引或者联合索引
- 待补充 

### 4.4 UPDATE/DELETE的WHERE条件列

- 数据按照某个条件进行查询后再进行UPDATE/DELETE， 对WHERE字段建立索引，就能大幅度提升效率
- 原理：<font color=orange>先要按照WHERE条件列检索出该条记录，然后再对其进行UPDATE/DELETE</font>
- 如果更新的字段是非索引字段，提升效率更加明显，因为不需要对非索引字段进行索引维护

### 4.5 DISTINCT字段

- 不加索引：全表扫描，将该字段在内存中去重
- 加索引：<font color=orange>B+树相邻去重更快</font>，同时查出的数据是<font color=orange>递增排序</font>

### 4.6 区分度高(散列性高)的列

- 列的基数：某一列中不重复数据的个数
- 区分度：列基数/记录行数，区分度越接近1，越适合做索引
- <font color=orange>联合索引把区分度高的列放在前面</font>

```sql
# 一般超过33%就算是比较高效的索引
SELECT COUNT(DISTINCt a)/COUNT(*) FROM t1;
```

## 6. 最佳实践

### 6.1 字符串前缀创建索引

### 6.2 单表的索引数量不超过6个

- <font color=orange>空间</font>：每个索引都需要占用磁盘空间
- <font color=orange>性能</font>：被索引的字段的写操作，需要维护索引
- <font color=orange>索引评估</font>： 优化器在选择如何优化查询时，会根据统一信息，对每一个可能用到的<font color=orange>索引来进行评估</font>，以生成一个最好的执行计划，如果有多个索引都可以用于查询，会<font color=orange>增加MySQL优化器生成执行计划时间</font>，降低查询性能

### 6.3 数据量小的表不要加索引

- 如果表记录少，比如少于1000个，不需要创建索引
- 索引产生的非聚簇索引，查询时候需要回表，效率可能会更低

# 性能分析

## 1. 查看系统性能参数

```sql
SHOW GLOBAL|SESSION STATUS LIKE 'connections';
```

| 参数                 | 描述                           |
| -------------------- | ------------------------------ |
| connections          | 连接MySQL服务器的次数          |
| uptime               | MySQL服务器的上线时间          |
| slow_queries         | 慢查询次数                     |
| Innodb_rows_read     | select查询返回的行数           |
| Innodb_rows_inserted | insert操作插入的行数           |
| Innodb_rows_updated  | update操作更新的行数           |
| Innodb_rows_deleted  | delete操作删除的行数           |
| com_select           | 查询操作的次数                 |
| com_insert           | 插入操作的次数，批量插入算一次 |
| com_update           | 更新操作的次数                 |
| com_delete           | 删除操作的次数                 |

## 2. 慢查询日志

- 用来记录在MySQL中<font color=orange>相应时间超过阈值</font>的语句，具体值运行时间超过<font color=orange>long_query_time</font>值的SQL，则会被记录到慢查询日志中
- long_query_time：默认是10s
- 作用：记录执行时间特别长的<font color=orange>SQL查询</font>，并且针对性的进行优化，提高系统的整体效率。当数据服务器发生阻塞，运行变慢，通过检查慢SQL日志，定位到慢查询来解决
- MySQL默认<font color=orange>不开启慢查询日志</font>，需要手动开启。<font color=orange>除非调优需要，一般不建议启动该参数</font>，因为开启慢查询日志会对性能带来一定影响

### 2.1 开启

```SQL
# 默认是OFF
SHOW VARIABLES LIKE '%slow_query_log%';

# 打开慢查询: 同时会有慢查询日志的文件
SET GLOBAL slow_query_log=ON;

slow_query_log,ON
slow_query_log_file,/var/lib/mysql/8bc168b1a471-slow.log

# 默认阈值： 10s
SHOW VARIABLES LIKE '%long_query_time%';

# 修改阈值: 1s
SET long_query_time = 1;

# 建议这些配置在mysql服务器中添加
```

### 2.2 分析

- mysqldumpslow -help ;

```sql
SHOW STATUS LIKE '%slow_queries';
```

## 3. Explain

- 定位到慢查询的SQL后，使用EXPLIAN或者DESCRIBE工具做针对性的分析查询语句
- Explain并没有真正执行后面的SQL语句，因此可以安全的查看执行计划
